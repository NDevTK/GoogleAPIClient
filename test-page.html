<!DOCTYPE html>
<html>
<head><title>AST Learning Test Page</title></head>
<body>
<h2>AST Learning Test Page</h2>
<p>Open the extension popup to check endpoints learned by AST static analysis.</p>
<p>The button below fires the actual requests — use it to compare network-learned vs AST-learned.</p>
<button id="fire" style="font-size:1.2em;padding:8px 20px;margin:12px 0">Fire All Requests</button>
<pre id="log" style="background:#f4f4f4;padding:12px;max-height:400px;overflow:auto"></pre>
<div id="xss-target" style="border:2px dashed #c00;padding:8px;margin:12px 0;min-height:20px;color:#c00;font-size:11px">XSS target element</div>

<!-- Real libraries — AST must parse these actual minified bundles -->
<script src="jquery.min.js"></script>
<script src="axios.min.js"></script>

<script>
// ══════════════════════════════════════════════════════════════════════════════
// BASIC — Direct fetch patterns
// ══════════════════════════════════════════════════════════════════════════════

// 1. Direct literal URL
function test1() {
  fetch("https://api.example.com/v1/users", {
    method: "GET",
    headers: { "Authorization": "Bearer token123" }
  });
}

// 2. POST with JSON body
function test2() {
  fetch("https://api.example.com/v1/documents", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title: "test", content: "hello" })
  });
}

// 3. Variable concatenation
function test3() {
  var API_BASE = "https://api.example.com";
  var endpoint = API_BASE + "/v1/search";
  fetch(endpoint, { method: "GET" });
}

// 4. Template literal with interpolation
function test4() {
  var userId = "user_42";
  fetch(`https://api.example.com/v1/users/${userId}/profile`);
}

// 5. Object property as URL and method
function test5() {
  var config = {
    apiUrl: "https://api.example.com/v1/settings",
    method: "PUT"
  };
  fetch(config.apiUrl, { method: config.method, headers: { "X-Custom": "value" } });
}

// 6. XHR
function test6() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://api.example.com/v1/status");
  xhr.setRequestHeader("Accept", "application/json");
  xhr.send();
}

// 7. window.fetch
function test7() {
  window.fetch("https://api.example.com/v1/health", { method: "HEAD" });
}

// ══════════════════════════════════════════════════════════════════════════════
// INTER-PROCEDURAL — Wrappers, closures, this-binding
// ══════════════════════════════════════════════════════════════════════════════

// 8. Simple wrapper with method + path params
function apiRequest(method, path, body) {
  return fetch("https://api.example.com" + path, {
    method: method,
    headers: { "Content-Type": "application/json" },
    body: body ? JSON.stringify(body) : undefined
  });
}
function test8() {
  apiRequest("POST", "/v1/orders", { item: "widget", qty: 3 });
  apiRequest("DELETE", "/v1/orders/123");
  apiRequest("GET", "/v1/inventory");
}

// 9. Object method with this.base
var client = {
  base: "https://api.example.com/v2",
  get: function(path) {
    return fetch(this.base + path);
  },
  post: function(path, data) {
    return fetch(this.base + path, { method: "POST", body: JSON.stringify(data) });
  }
};
function test9() {
  client.get("/products");
  client.post("/products", { name: "gadget", price: 9.99 });
}

// 10. Closure-style assigned method
var analytics = {};
analytics.track = function(event) {
  return fetch("https://analytics.example.com/v1/events", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ event: event, ts: Date.now() })
  });
};
function test10() {
  analytics.track("page_view");
}

// 11. Nested wrapper chain (2 levels: apiGet → makeRequest → fetch)
function makeRequest(url, opts) {
  return fetch(url, opts);
}
function apiGet(path) {
  return makeRequest("https://api.example.com" + path, { method: "GET" });
}
function test11() {
  apiGet("/v1/notifications");
  apiGet("/v1/preferences");
}

// 12. Factory function returning a configured fetcher
function createClient(baseUrl) {
  return {
    get: function(path) {
      return fetch(baseUrl + path);
    },
    post: function(path, data) {
      return fetch(baseUrl + path, { method: "POST", body: JSON.stringify(data) });
    }
  };
}
var paymentsApi = createClient("https://payments.example.com/v1");
function test12() {
  paymentsApi.get("/transactions");
  paymentsApi.post("/charge", { amount: 1000, currency: "usd" });
}

// 13. Prototype-based class with methods
function ApiService(base) {
  this.base = base;
}
ApiService.prototype.fetch = function(path, method) {
  return fetch(this.base + path, { method: method || "GET" });
};
var svc = new ApiService("https://api.example.com/v3");
function test13() {
  svc.fetch("/items", "GET");
  svc.fetch("/items", "POST");
}

// 14. Multiple callers to one wrapper with different methods
function rpc(service, method, payload) {
  return fetch("https://api.example.com/rpc/" + service + "/" + method, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
}
function test14() {
  rpc("auth", "login", { user: "admin", pass: "secret" });
  rpc("auth", "refresh", { token: "abc" });
  rpc("billing", "invoice", { id: 42 });
}

// ══════════════════════════════════════════════════════════════════════════════
// MINIFIED PATTERNS — Simulating Closure/webpack output
// ══════════════════════════════════════════════════════════════════════════════

// 15. Single-letter variables (minified style)
function test15() {
  var a = "https://api.example.com/v1/minified";
  var b = { method: "PATCH", headers: { "X-Request-Id": "r123" } };
  fetch(a, b);
}

// 16. Chained ternary URL selection
function test16() {
  var env = "prod";
  var base = env === "prod" ? "https://api.example.com" : "https://staging.example.com";
  fetch(base + "/v1/config");
}

// 17. IIFE module pattern (common in bundles)
var mod = (function() {
  var BASE = "https://api.example.com/internal";
  return {
    ping: function() { return fetch(BASE + "/ping"); },
    sync: function(data) {
      return fetch(BASE + "/sync", {
        method: "POST",
        body: JSON.stringify(data)
      });
    }
  };
})();
function test17() {
  mod.ping();
  mod.sync({ ts: Date.now() });
}

// 18. Reassigned variable URL
function test18() {
  var url = "https://api.example.com/v1/default";
  var mode = "custom";
  if (mode === "custom") {
    url = "https://api.example.com/v1/custom";
  }
  fetch(url);
}

// ══════════════════════════════════════════════════════════════════════════════
// VALUE CONSTRAINTS — Switch, includes, equality chains
// ══════════════════════════════════════════════════════════════════════════════

// 19. Switch/case constraints
function loadResource(type) {
  switch(type) {
    case "users": return fetch("https://api.example.com/v1/users");
    case "posts": return fetch("https://api.example.com/v1/posts");
    case "comments": return fetch("https://api.example.com/v1/comments");
  }
}

// 20. .includes() constraint
var ALLOWED_FORMATS = ["json", "xml", "csv", "protobuf"];
function exportData(format) {
  if (ALLOWED_FORMATS.includes(format)) {
    fetch("https://api.example.com/v1/export?format=" + format);
  }
}

// 21. Equality chain constraint
function processAction(action) {
  if (action === "approve" || action === "reject" || action === "defer") {
    fetch("https://api.example.com/v1/actions/" + action, { method: "POST" });
  }
}

// 22b. POST with body field value constraints
var VALID_ROLES = ["admin", "editor", "viewer", "guest"];
var VALID_STATUSES = ["active", "suspended", "pending"];
function createUser(name, role, status) {
  if (VALID_ROLES.includes(role) && VALID_STATUSES.includes(status)) {
    fetch("https://api.example.com/v1/users/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: name, role: role, status: status })
    });
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// PROTO DETECTION — Enums and field maps
// ══════════════════════════════════════════════════════════════════════════════

// 22. Proto enum
var EventType = { UNKNOWN: 0, PAGE_VIEW: 1, CLICK: 2, SCROLL: 3, SUBMIT: 4 };

// 23. Proto field map
function EventMessage() {}
EventMessage.prototype.getType = function() {
  return jspb.Message.getField(this, 1);
};
EventMessage.prototype.getName = function() {
  return jspb.Message.getField(this, 2);
};
EventMessage.prototype.getTimestamp = function() {
  return jspb.Message.getField(this, 3);
};

// 24. Second proto message to test multiple detection
var Priority = { LOW: 0, MEDIUM: 1, HIGH: 2, CRITICAL: 3 };

function TaskMessage() {}
TaskMessage.prototype.getTitle = function() {
  return jspb.Message.getField(this, 1);
};
TaskMessage.prototype.getPriority = function() {
  return jspb.Message.getField(this, 2);
};
TaskMessage.prototype.getAssignee = function() {
  return jspb.Message.getField(this, 3);
};
TaskMessage.prototype.getDueDate = function() {
  return jspb.Message.getField(this, 4);
};

// ══════════════════════════════════════════════════════════════════════════════
// GOOGLE-STYLE — Patterns from real Closure-compiled bundles
// ══════════════════════════════════════════════════════════════════════════════

// 25. Closure goog.module pattern — assigned from IIFE
var goog$module$search = {};
goog$module$search.execute = function(query, opts) {
  return fetch("https://www.googleapis.com/search/v1/query", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ q: query, options: opts })
  });
};
function test25() {
  goog$module$search.execute("hello world", { lang: "en" });
}

// 26. Nested config object
function test26() {
  var cfg = {
    endpoints: {
      upload: "https://storage.example.com/v1/upload",
      download: "https://storage.example.com/v1/download"
    }
  };
  fetch(cfg.endpoints.upload, { method: "POST", body: "file-data" });
  fetch(cfg.endpoints.download);
}

// 27. URL built from multiple parts
function test27() {
  var proto = "https://";
  var host = "api.example.com";
  var version = "/v4";
  var resource = "/metrics";
  fetch(proto + host + version + resource);
}

// 28. Conditional method based on data presence
function upsert(id, data) {
  var method = id ? "PUT" : "POST";
  var url = id
    ? "https://api.example.com/v1/records/" + id
    : "https://api.example.com/v1/records";
  fetch(url, { method: method, body: JSON.stringify(data) });
}
function test28() {
  upsert(null, { name: "new" });
  upsert("rec_123", { name: "updated" });
}

// 29. Options spread from base config
function test29() {
  var baseOpts = { headers: { "X-App": "test", "Accept": "application/json" } };
  fetch("https://api.example.com/v1/whoami", Object.assign({ method: "GET" }, baseOpts));
}

// 30. Multiple XHR patterns
function test30() {
  var x1 = new XMLHttpRequest();
  x1.open("POST", "https://telemetry.example.com/v1/events");
  x1.setRequestHeader("Content-Type", "application/json");
  x1.send(JSON.stringify({ type: "load" }));

  var x2 = new XMLHttpRequest();
  x2.open("PUT", "https://telemetry.example.com/v1/session");
  x2.send();
}

// ══════════════════════════════════════════════════════════════════════════════
// JQUERY — Real jQuery 3.7.1 loaded via <script src="jquery.min.js">
// jQuery internally uses XMLHttpRequest — AST must trace through its internals
// ══════════════════════════════════════════════════════════════════════════════

// 31. $.ajax with full config
function test31() {
  $.ajax({
    url: "https://api.example.com/v1/jquery/users",
    type: "GET",
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });
}

// 32. $.get shorthand
function test32() {
  $.get("https://api.example.com/v1/jquery/posts");
}

// 33. $.post with data
function test33() {
  $.post("https://api.example.com/v1/jquery/messages", { text: "hello", to: "user1" });
}

// 34. $.getJSON
function test34() {
  $.getJSON("https://api.example.com/v1/jquery/config");
}

// 35. jQuery IIFE module pattern — $ passed as closure parameter
var jqModule = (function($) {
  return {
    load: function() {
      return $.ajax({
        url: "https://api.example.com/v1/jquery/dashboard",
        type: "GET"
      });
    },
    save: function(data) {
      return $.post("https://api.example.com/v1/jquery/save", data);
    }
  };
})(jQuery);
function test35() {
  jqModule.load();
  jqModule.save({ key: "value" });
}

// 36. $.ajax with beforeSend and dynamic URL
function test36() {
  var resource = "comments";
  $.ajax({
    url: "https://api.example.com/v1/jquery/" + resource,
    type: "DELETE",
    beforeSend: function(xhr) { xhr.setRequestHeader("X-CSRF", "token"); }
  });
}

// 37. jQuery $.ajax with JSON body and contentType
function test37() {
  $.ajax({
    url: "https://api.example.com/v1/jquery/search",
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({ query: "test", page: 1 }),
    headers: { "X-Request-Id": "abc123" }
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// OTHER LIBRARIES — Axios-style, superagent-style, other browser APIs
// ══════════════════════════════════════════════════════════════════════════════

// 38. Real Axios — loaded via <script src="axios.min.js">
// Axios internally uses XMLHttpRequest — AST must trace through its internals
function test38() {
  axios.get("https://api.example.com/v1/axios/items", { headers: { "Accept": "application/json" } });
  axios.post("https://api.example.com/v1/axios/items", { name: "widget", price: 42 });
  axios.put("https://api.example.com/v1/axios/items/123", { name: "updated" });
  axios.delete("https://api.example.com/v1/axios/items/456");
}

// 39. Axios instance with baseURL
function test39() {
  var api = axios.create({ baseURL: "https://api.example.com/v1/axinst" });
  api.get("/tasks", { headers: { "Authorization": "Bearer tok123" } });
  api.post("/tasks", { title: "New task", priority: "high" });
}

// 40. navigator.sendBeacon — browser API for analytics/telemetry
function test40() {
  navigator.sendBeacon(
    "https://analytics.example.com/v1/beacon",
    JSON.stringify({ event: "page_exit", duration: 30000 })
  );
}

// 41. EventSource — Server-Sent Events
function test41() {
  var es = new EventSource("https://api.example.com/v1/stream/notifications");
  es.onmessage = function(e) { /* handle */ };
}

// 42. Image pixel beacon (common in tracking)
function test42() {
  var img = new Image();
  img.src = "https://analytics.example.com/v1/pixel?event=impression&campaign=summer";
}

// ══════════════════════════════════════════════════════════════════════════════
// ADVANCED DATA FLOW — Loops, iteration, dynamic dispatch
// ══════════════════════════════════════════════════════════════════════════════

// 43. Array of configs iterated with for loop
function test43() {
  var endpoints = [
    { url: "https://api.example.com/v1/batch/users", method: "GET" },
    { url: "https://api.example.com/v1/batch/roles", method: "GET" },
    { url: "https://api.example.com/v1/batch/permissions", method: "POST" }
  ];
  for (var i = 0; i < endpoints.length; i++) {
    fetch(endpoints[i].url, { method: endpoints[i].method });
  }
}

// 44. URL map with Object.keys
function test44() {
  var urls = {
    profile: "https://api.example.com/v1/map/profile",
    settings: "https://api.example.com/v1/map/settings",
    billing: "https://api.example.com/v1/map/billing"
  };
  var keys = Object.keys(urls);
  for (var i = 0; i < keys.length; i++) {
    fetch(urls[keys[i]]);
  }
}

// 45. Fetch wrapper that adds auth (middleware/interceptor pattern)
function authFetch(url, options) {
  var opts = options || {};
  if (!opts.headers) opts.headers = {};
  opts.headers["Authorization"] = "Bearer " + "globalToken123";
  return fetch(url, opts);
}
function test45() {
  authFetch("https://api.example.com/v1/auth/me");
  authFetch("https://api.example.com/v1/auth/permissions", { method: "POST", body: JSON.stringify({ scope: "admin" }) });
}

// 46. Retry wrapper — same fetch call repeated
function fetchWithRetry(url, opts, maxRetries) {
  return fetch(url, opts);
}
function test46() {
  fetchWithRetry("https://api.example.com/v1/retry/data", { method: "GET" }, 3);
}

// 47. Config-driven API client — URLs from config object, method from call
var apiConfig = {
  usersUrl: "https://api.example.com/v1/cfg/users",
  ordersUrl: "https://api.example.com/v1/cfg/orders",
  productsUrl: "https://api.example.com/v1/cfg/products"
};
function apiCall(configKey, method, body) {
  return fetch(apiConfig[configKey], {
    method: method,
    headers: { "Content-Type": "application/json" },
    body: body ? JSON.stringify(body) : undefined
  });
}
function test47() {
  apiCall("usersUrl", "GET");
  apiCall("ordersUrl", "POST", { item: "thing" });
  apiCall("productsUrl", "GET");
}

// 48. Higher-order function — returns a configured fetcher
function createEndpoint(method, url) {
  return function(data) {
    return fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: data ? JSON.stringify(data) : undefined
    });
  };
}
var getUsers = createEndpoint("GET", "https://api.example.com/v1/hof/users");
var createUser = createEndpoint("POST", "https://api.example.com/v1/hof/users");
var deleteAccount = createEndpoint("DELETE", "https://api.example.com/v1/hof/account");
function test48() {
  getUsers();
  createUser({ name: "Alice", email: "alice@example.com" });
  deleteAccount();
}

// ══════════════════════════════════════════════════════════════════════════════
// SECURITY — Intentional XSS sinks, open redirects, dangerous patterns
// These should trigger findings in the Security tab.
// ══════════════════════════════════════════════════════════════════════════════

// 49. DOM XSS: location.hash → innerHTML
function vuln_hashXSS() {
  var payload = location.hash.substring(1);
  document.getElementById("xss-target").innerHTML = payload;
}

// 50. DOM XSS: location.search → document.write
function vuln_searchWrite() {
  var params = location.search;
  document.write("<div>" + params + "</div>");
}

// 51. DOM XSS: document.referrer → outerHTML
function vuln_referrerOuter() {
  var ref = document.referrer;
  document.getElementById("xss-target").outerHTML = "<span>" + ref + "</span>";
}

// 52. Eval injection: location.hash → eval
function vuln_evalHash() {
  var code = decodeURIComponent(location.hash.slice(1));
  eval(code);
}

// 53. DOM XSS: URL search param → insertAdjacentHTML
function vuln_insertAdjacent() {
  var q = location.search.substring(1);
  document.getElementById("xss-target").insertAdjacentHTML("beforeend", q);
}

// 54. DOM XSS: window.name → innerHTML (cross-window taint)
function vuln_windowName() {
  var data = window.name;
  document.getElementById("xss-target").innerHTML = data;
}

// 55. DOM XSS: document.cookie → innerHTML
function vuln_cookieXSS() {
  var cookies = document.cookie;
  document.getElementById("xss-target").innerHTML = "<pre>" + cookies + "</pre>";
}

// 56. Open redirect: location.hash → location.href
function vuln_openRedirect() {
  var url = location.hash.substring(1);
  location.href = url;
}

// 57. Open redirect: search param → location.assign
function vuln_redirectAssign() {
  var next = location.search.split("next=")[1];
  location.assign(next);
}

// 58. DOM XSS: setAttribute with event handler
function vuln_setAttributeOnError() {
  var handler = location.hash.substring(1);
  document.getElementById("xss-target").setAttribute("onerror", handler);
}

// 59. Eval via setTimeout with string argument
function vuln_setTimeoutEval() {
  var action = location.search.substring(1);
  setTimeout(action, 0);
}

// 60. Eval via new Function
function vuln_newFunction() {
  var body = location.hash.substring(1);
  var fn = new Function("x", body);
  fn(42);
}

// 61. postMessage listener without origin check
window.addEventListener("message", function(e) {
  document.getElementById("xss-target").innerHTML = e.data;
});

// 62. Prototype pollution with user-controlled key
function vuln_protoPollution() {
  var key = location.hash.substring(1);
  var obj = {};
  obj[key] = true;
}

// 63. Multi-hop taint: location.search → variable → function → innerHTML
function vuln_multiHop() {
  var raw = location.search;
  var decoded = decodeURIComponent(raw);
  renderContent(decoded);
}
function renderContent(html) {
  document.getElementById("xss-target").innerHTML = html;
}

// 64. Template literal XSS: location.hash → template → innerHTML
function vuln_templateXSS() {
  var tag = location.hash.substring(1);
  document.getElementById("xss-target").innerHTML = `<b class="${tag}">styled</b>`;
}

// 65. Open redirect via window.location.replace
function vuln_locationReplace() {
  var dest = location.search.split("url=")[1];
  window.location.replace(dest);
}

// --- Button handler: fire everything ---
document.getElementById("fire").onclick = function() {
  var log = document.getElementById("log");
  log.textContent = "Firing all requests...\n";
  var tests = [
    ["1.  Direct GET", test1],
    ["2.  POST + body", test2],
    ["3.  Variable concat", test3],
    ["4.  Template literal", test4],
    ["5.  Object property", test5],
    ["6.  XHR", test6],
    ["7.  HEAD window.fetch", test7],
    ["8.  Wrapper (inter-proc)", test8],
    ["9.  this.base method", test9],
    ["10. Closure assigned", test10],
    ["11. Nested 2-level", test11],
    ["12. Factory client", test12],
    ["13. Prototype class", test13],
    ["14. Multi-caller RPC", test14],
    ["15. Minified vars", test15],
    ["16. Ternary URL", test16],
    ["17. IIFE module", test17],
    ["18. Reassigned URL", test18],
    ["19. Switch", function() { loadResource("users"); }],
    ["20. Includes", function() { exportData("json"); }],
    ["21. Equality chain", function() { processAction("approve"); }],
    ["25. Closure module", test25],
    ["26. Nested config", test26],
    ["27. Multi-part URL", test27],
    ["28. Conditional upsert", test28],
    ["29. Options spread", test29],
    ["30. Multi XHR", test30],
    ["31. $.ajax config", test31],
    ["32. $.get", test32],
    ["33. $.post", test33],
    ["34. $.getJSON", test34],
    ["35. jQuery module", test35],
    ["36. $.ajax dynamic", test36],
    ["37. $.ajax JSON POST", test37],
    ["38. Real Axios", test38],
    ["39. Axios instance", test39],
    ["40. sendBeacon", test40],
    ["41. EventSource", test41],
    ["42. Image pixel", test42],
    ["43. Array loop", test43],
    ["44. URL map", test44],
    ["45. Auth wrapper", test45],
    ["46. Retry wrapper", test46],
    ["47. Config-driven", test47],
    ["48. Higher-order fn", test48],
  ];
  for (var i = 0; i < tests.length; i++) {
    try {
      tests[i][1]();
      log.textContent += "  OK: " + tests[i][0] + "\n";
    } catch(e) {
      log.textContent += "  ERR: " + tests[i][0] + " — " + e.message + "\n";
    }
  }
  log.textContent += "\nDone! Check popup for network-learned endpoints.";
};
</script>

<!-- ════════════════════════════════════════════════════════════════════════════
     CROSS-FILE SCANNING TESTS
     These test patterns where taint sources and sinks span separate <script> tags.
     The extension's combined analysis (forceScript=true) concatenates all scripts
     into a shared global scope, so cross-file data flow should be detected.
     ════════════════════════════════════════════════════════════════════════════ -->

<!-- Script A: defines tainted globals (simulates a config/init script) -->
<script>
// 66. Cross-file: taint source in one script, sink in another
var crossFilePayload = location.hash.substring(1);

// 67. Cross-file: tainted utility function defined here, called from another script
function renderUnsafe(html) {
  document.getElementById("xss-target").innerHTML = html;
}

// 68. Cross-file: global config object with tainted values
var appConfig = {
  redirectUrl: location.search.split("next=")[1],
  userName: location.hash.substring(1),
  debugCode: location.hash.substring(1),
};

// 69. Cross-file: tainted class method
function UnsafeRenderer() {}
UnsafeRenderer.prototype.render = function(content) {
  document.getElementById("xss-target").outerHTML = content;
};

// 70. Cross-file: API URL builder with tainted base
var apiBase = location.hash.substring(1);
function buildApiUrl(path) {
  return apiBase + "/api/" + path;
}
</script>

<!-- Script B: uses tainted globals from Script A (simulates app code) -->
<!-- All sinks wrapped in functions so AST analyzes them without auto-executing -->
<script>
// 66b. Sink using cross-file tainted variable
function vuln_crossFileInnerHTML() {
  document.getElementById("xss-target").innerHTML = crossFilePayload;
}

// 67b. Calling cross-file tainted utility
function vuln_crossFileUtility() {
  var userInput = location.search.substring(1);
  renderUnsafe(userInput);
}

// 68b. Cross-file: config object property → redirect
function vuln_crossFileRedirect() {
  location.assign(appConfig.redirectUrl);
}

// 68c. Cross-file: config object property → eval
function vuln_crossFileEval() {
  eval(appConfig.debugCode);
}

// 69b. Cross-file: instantiate class from Script A, pass tainted data
function vuln_crossFileClass() {
  var renderer = new UnsafeRenderer();
  renderer.render(location.hash.substring(1));
}

// 70b. Cross-file: use builder with tainted base → setAttribute href
function vuln_crossFileSetAttr() {
  var link = document.createElement("a");
  link.setAttribute("href", buildApiUrl("users"));
}

// 71. Cross-file: postMessage handler in separate script from listener setup
function handleCrossMessage(data) {
  document.getElementById("xss-target").innerHTML = data;
}
</script>

<!-- Script C: more cross-file patterns (simulates a third-party widget) -->
<!-- All sinks wrapped in functions so AST analyzes them without auto-executing -->
<script>
// 71b. Cross-file: window.addEventListener dispatching to handler in Script B
window.addEventListener("message", function(e) {
  handleCrossMessage(e.data);
});

// 72. Cross-file: document.write with tainted value from Script A's config
function vuln_crossFileDocWrite() {
  document.write("<div>" + appConfig.userName + "</div>");
}

// 73. Cross-file: setTimeout with tainted string from Script A's config
function vuln_crossFileSetTimeout() {
  setTimeout(appConfig.debugCode, 100);
}

// 74. Cross-file: new Function with cross-file tainted var
function vuln_crossFileNewFunction() {
  var fn = new Function("return " + crossFilePayload);
}

// 75. Cross-file: createContextualFragment with tainted input
function vuln_crossFileFragment() {
  var range = document.createRange();
  range.selectNode(document.body);
  var frag = range.createContextualFragment(crossFilePayload);
  document.body.appendChild(frag);
}

// 76. Cross-file: fetch URL built from tainted base in Script A
function vuln_crossFileFetch() {
  fetch(buildApiUrl("admin/delete"));
}
</script>
</body>
</html>
